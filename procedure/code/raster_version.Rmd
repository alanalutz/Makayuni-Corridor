---
title: "wildlife_corridor.rmd"
author: "Andy Atallah"
date: "2023-11-30"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r}
# Install packages
install.packages('tidyverse')
install.packages('here')
install.packages('sf')
install.packages('stars')
install.packages('raster')
library(tidyverse)
library(here)
library(sf)
library(stars)
#library(rgdal)
library(raster)
```


2. Clip landcover by bounding_box.

landcover (GEOMETRY FILE) [CLIP] initial_clip (GEOMETRY FILE)

Inputs: landcover, bounding_box
Outputs: unnamed intermediate "lc_study_clip"
Possible functions: raster::raster

Note: unplanned deviation from original study
Decided not to clip landcover to initial_clip before clipping to bounding_box, as this seemed unnecessary

```{r}
landcover <- here("data", "raw", "public", "landcover.tif") %>% raster()
bounds <- here("data", "raw", "public", "bounding_box.shp") %>% st_read()

st_crs(bounds)
proj4string(landcover)

# Reproject bounds to landcover CRS
bounds <- bounds %>% st_transform(proj4string(landcover))


# Crop
lc_study_clip <- mask(crop(landcover, extent(bounds)), bounds)

```

```{r}
plot(lc_study_clip)
```

3a. Warp (reproject) output_2a ["lc_study_clip"] to CRS=32736.


Inputs: initial_raster_clip
Outputs: unnamed_intermediate "initial_raster_clip_proj"
Possible functions: raster::projectRaster
```{r}

lc_study_clip_reproj <- projectRaster(lc_study_clip, crs=32736, filename="lc_study_clip_reproj")

```

```{r}
plot(lc_study_clip_reproj)
```

4a. Reclassify landcover by table.

Unplanned deviation: changed reclass table

Inputs: "lc_study_clip"
Outputs: unnamed intermediate "lc_reclass"
Possible functions: raster::reclassify
```{r}
# Create 3x10 table of values with which to reclassify
# Data source: the online Google Drive folder flowchart

c1 <- c(0,1,2,3,4,5,6,7,8,9)
c2 <- c(0,2,3,4,5,6,7,8,9,255)
c3 <- c(0,0.75,0.01,0.25,0.01,0.15,1,0.1,0.15,0)
reclass_table <- as.matrix(data.frame(c1, c2, c3))

lc_reclass <- reclassify(lc_study_clip_reproj, reclass_table, filename="lc_reclass", right=F, overwrite=T)
```

```{r}
plot(lc_reclass)
```


1a. Reproject secondary roads to CRS=32736.

secondary_roads (GEOMETRY FILE) --> [Reproject] to EPSG:32736 - WGS 84 / UTM zone 36S

Inputs: secondary_roads
Outputs: unnamed intermediate "output_1a"
Possible functions: sf::read_sf, raster::shapefile, st::st_transform
```{r}
secondary_roads <- here("data", "raw", "public", "secondary_roads.shp") %>% st_read()

output_1a <- st_transform(secondary_roads, crs=32736)
```

1b. Rasterize secondary roads.

"1a output" (GEOMETRY FILE) --> [Rasterize]

Inputs: "output_1a"
Outputs: unnamed intermediate "secondary_roads_raster"
Possible functions: stars::st_rasterize
```{r}
secondary_roads_raster <- st_rasterize(output_1a)

#Takes as an input a stars raster layer
#CJ Brown 2020-05-18

st_as_raster <- function(rstars){
  rext <- st_bbox(rstars)
  raster(t(rstars[[1]]), xmn = rext[1], xmx = rext[3],
                   ymn = rext[2], ymx=rext[4],
                   crs = st_crs(rstars)$proj4string)
}

secondary_roads_raster <- st_as_raster(secondary_roads_raster) %>% setExtent(extent(lc_study_clip_reproj)) %>% resample(lc_study_clip_reproj)

```

```{r}
plot(secondary_roads_raster)

```

Major Roads

Unplanned deviation: buffer after rasterizing

```{r}
major_roads <- here("data", "raw", "public", "major_roads_vector.shp") %>% st_read()

major_roads_reproj <- major_roads %>% st_transform(crs=32736)

major_roads_raster <- st_rasterize(major_roads_reproj)

major_roads_raster <- st_as_raster(major_roads_raster)

major_roads_buff <- major_roads_raster %>% buffer(width=300)

major_roads_raster <- major_roads_buff %>% setExtent(extent(lc_study_clip_reproj)) %>% resample(lc_study_clip_reproj)

```

```{r}
plot(major_roads_raster)

```

Bomas (rural)

```{r}
rural <- here("data", "raw", "public", "bomas.shp") %>% st_read()

rural_reproj <- rural %>% st_transform(crs=32736)

```

```{r}
plot(rural_reproj)

```

Buildings

```{r}
buildings <- here("data", "raw", "public", "merged_buildings.shp") %>% st_read() %>% st_as_stars()

buildings_reproj <- buildings %>% st_transform(crs=32736)

```

```{r}
plot(buildings_reproj)

```

Figure out why buildings are not rasterizing properly and why bomas are off

```{r}

buildings_raster <- st_rasterize(buildings_reproj)

buildings_raster <- st_as_raster(buildings_raster) %>% setExtent(extent(lc_study_clip_reproj)) %>% resample(lc_study_clip_reproj)

rural_raster <- st_rasterize(rural_reproj)

rural_raster <- st_as_raster(rural_raster) %>% setExtent(extent(lc_study_clip_reproj)) %>% resample(lc_study_clip_reproj)

merged_buildings <- overlay(buildings_raster, rural_raster, fun=function(x,y){return(x | y)})

```

```{r}
plot(buildings_raster)

```

Figure out why proximity takes so long

```{r}
proximity = distance(merged_buildings)

plot(proximity)

```

Reclassify proximity raster

```{r}
c1 <- c(0, 1, 50, 100, 150, 200)
c2 <- c(1, 50, 100, 150, 200, 1000)
c3 <- c(1, 0.8, 0.6, 0.4, 0.2, 0)
prox_reclass_table <- as.matrix(data.frame(c1, c2, c3))

prox_reclass <- reclassify(proximity, prox_reclass_table)
```



6a. Rasterize buffer zone.

Inputs: "buffer_region"
Outputs: unnamed intermediate "buffer_raster"
Possible functions: raster::raster
```{r}
buffer_zone <- here("data", "raw", "public", "buffer_region") %>% st_read()

buffer_raster <- st_rasterize(buffer_zone)
```






7. 






